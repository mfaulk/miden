<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Code Organization - Polygon Miden VM</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../intro/main.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../intro/overview.html"><strong aria-hidden="true">1.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../intro/usage.html"><strong aria-hidden="true">1.2.</strong> Usage</a></li><li class="chapter-item expanded "><a href="../../intro/performance.html"><strong aria-hidden="true">1.3.</strong> Performance</a></li></ol></li><li class="chapter-item expanded "><a href="../../user_docs/main.html"><strong aria-hidden="true">2.</strong> User Documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../user_docs/assembly/main.html"><strong aria-hidden="true">2.1.</strong> Miden Assembly</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../user_docs/assembly/code_organization.html" class="active"><strong aria-hidden="true">2.1.1.</strong> Code Organization</a></li><li class="chapter-item expanded "><a href="../../user_docs/assembly/execution_contexts.html"><strong aria-hidden="true">2.1.2.</strong> Execution contexts</a></li><li class="chapter-item expanded "><a href="../../user_docs/assembly/flow_control.html"><strong aria-hidden="true">2.1.3.</strong> Flow Control</a></li><li class="chapter-item expanded "><a href="../../user_docs/assembly/field_operations.html"><strong aria-hidden="true">2.1.4.</strong> Field Operations</a></li><li class="chapter-item expanded "><a href="../../user_docs/assembly/u32_operations.html"><strong aria-hidden="true">2.1.5.</strong> u32 Operations</a></li><li class="chapter-item expanded "><a href="../../user_docs/assembly/stack_manipulation.html"><strong aria-hidden="true">2.1.6.</strong> Stack manipulation</a></li><li class="chapter-item expanded "><a href="../../user_docs/assembly/io_operations.html"><strong aria-hidden="true">2.1.7.</strong> Input / Output Operations</a></li><li class="chapter-item expanded "><a href="../../user_docs/assembly/cryptographic_operations.html"><strong aria-hidden="true">2.1.8.</strong> Cryptographic Operations</a></li></ol></li><li class="chapter-item expanded "><a href="../../user_docs/stdlib/main.html"><strong aria-hidden="true">2.2.</strong> Miden Standard Library</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../user_docs/stdlib/crypto/fri.html"><strong aria-hidden="true">2.2.1.</strong> std::crypto::fri</a></li><li class="chapter-item expanded "><a href="../../user_docs/stdlib/crypto/hashes.html"><strong aria-hidden="true">2.2.2.</strong> std::crypto::hashes</a></li><li class="chapter-item expanded "><a href="../../user_docs/stdlib/math/u64.html"><strong aria-hidden="true">2.2.3.</strong> std::math::u64</a></li><li class="chapter-item expanded "><a href="../../user_docs/stdlib/mem.html"><strong aria-hidden="true">2.2.4.</strong> std::mem</a></li><li class="chapter-item expanded "><a href="../../user_docs/stdlib/sys.html"><strong aria-hidden="true">2.2.5.</strong> std:sys</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../design/main.html"><strong aria-hidden="true">3.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../design/programs.html"><strong aria-hidden="true">3.1.</strong> Programs</a></li><li class="chapter-item expanded "><a href="../../design/decoder/main.html"><strong aria-hidden="true">3.2.</strong> Program decoder</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../design/decoder/constraints.html"><strong aria-hidden="true">3.2.1.</strong> Decoder constraints</a></li></ol></li><li class="chapter-item expanded "><a href="../../design/stack/main.html"><strong aria-hidden="true">3.3.</strong> Operand stack</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../design/stack/op_constraints.html"><strong aria-hidden="true">3.3.1.</strong> Operation constraints</a></li><li class="chapter-item expanded "><a href="../../design/stack/system_ops.html"><strong aria-hidden="true">3.3.2.</strong> System operations</a></li><li class="chapter-item expanded "><a href="../../design/stack/field_ops.html"><strong aria-hidden="true">3.3.3.</strong> Field operations</a></li><li class="chapter-item expanded "><a href="../../design/stack/u32_ops.html"><strong aria-hidden="true">3.3.4.</strong> u32 operations</a></li><li class="chapter-item expanded "><a href="../../design/stack/stack_ops.html"><strong aria-hidden="true">3.3.5.</strong> Stack manipulation</a></li><li class="chapter-item expanded "><a href="../../design/stack/io_ops.html"><strong aria-hidden="true">3.3.6.</strong> Input / output operations</a></li><li class="chapter-item expanded "><a href="../../design/stack/crypto_ops.html"><strong aria-hidden="true">3.3.7.</strong> Cryptographic operations</a></li></ol></li><li class="chapter-item expanded "><a href="../../design/range.html"><strong aria-hidden="true">3.4.</strong> Range Checker</a></li><li class="chapter-item expanded "><a href="../../design/chiplets/main.html"><strong aria-hidden="true">3.5.</strong> Chiplets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../design/chiplets/hasher.html"><strong aria-hidden="true">3.5.1.</strong> Hash Chiplet</a></li><li class="chapter-item expanded "><a href="../../design/chiplets/bitwise.html"><strong aria-hidden="true">3.5.2.</strong> Bitwise Chiplet</a></li><li class="chapter-item expanded "><a href="../../design/chiplets/memory.html"><strong aria-hidden="true">3.5.3.</strong> Memory Chiplet</a></li></ol></li><li class="chapter-item expanded "><a href="../../design/multiset.html"><strong aria-hidden="true">3.6.</strong> Multiset checks</a></li></ol></li><li class="chapter-item expanded "><a href="../../background.html"><strong aria-hidden="true">4.</strong> Background Material</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Polygon Miden VM</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/0xPolygonMiden/miden-vm/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h2 id="code-organization"><a class="header" href="#code-organization">Code organization</a></h2>
<p>A Miden assembly program is just a sequence of instructions each describing a specific directive or an operation. You can use any combination of whitespace characters to separate one instruction from another.</p>
<p>In turn, Miden assembly instructions are just keywords which can be parameterized by zero or more parameters. The notation for specifying parameters is <em>keyword.param1.param2</em> - i.e., the parameters are separated by periods. For example, <code>push.123</code> instruction denotes a <code>push</code> operation which is parameterized by value <code>123</code>.</p>
<p>Miden assembly programs are organized into procedures. Procedures, in turn, can be grouped into modules.</p>
<h3 id="procedures"><a class="header" href="#procedures">Procedures</a></h3>
<p>A <em>procedure</em> can be used to encapsulate a frequently-used sequence of instructions which can later be invoked via a label. A procedure must start with a <code>proc.&lt;label&gt;.&lt;number of locals&gt;</code> instruction and terminate with an <code>end</code> instruction. For example:</p>
<pre><code>proc.foo.2
    &lt;instructions&gt;
end
</code></pre>
<p>A procedure label must start with a letter and can contain any combination of numbers, ASCII letters, and underscores (<code>_</code>). The number of characters in the procedure label cannot exceed 100.</p>
<p>The number of locals specifies the number of memory-based local words a procedure can access (via <code>loc_load</code>, <code>loc_store</code>, and <a href="./io_operations.html#random-access-memory">other instructions</a>). If a procedure doesn't need any memory-based locals, this parameter can be omitted or set to <code>0</code>. A procedure can have at most <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">16</span></span></span></span></span></span></span></span></span></span></span></span> locals, and the total number of locals available to all procedures at runtime is limited to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">30</span></span></span></span></span></span></span></span></span></span></span></span>.</p>
<p>To execute a procedure, the <code>exec.&lt;label&gt;</code>, <code>call.&lt;label&gt;</code>, and <code>syscall.&lt;label&gt;</code> instructions can be used. For example:</p>
<pre><code>exec.foo
</code></pre>
<p>The difference between using each of these instructions is explained in the <a href="./execution_contexts.html#procedure-invocation-semantics">next section</a>.</p>
<p>A procedure may execute any other previously defined procedure, but it cannot execute itself or any of the subsequent procedures. Thus, recursive procedure calls are not possible. For example, the following code block defines a program with two procedures:</p>
<pre><code>proc.foo
    &lt;instructions&gt;
end

proc.bar
    &lt;instructions&gt;
    exec.foo
    &lt;instructions&gt;
end

begin
    &lt;instructions&gt;
    exec.bar
    &lt;instructions&gt;
    exec.foo
end
</code></pre>
<h3 id="modules"><a class="header" href="#modules">Modules</a></h3>
<p>A <em>module</em> consists of one or more procedures. There are two types of modules: <em>library modules</em> and <em>executable modules</em> (also called <em>programs</em>).</p>
<h4 id="library-modules"><a class="header" href="#library-modules">Library modules</a></h4>
<p>Library modules contain zero or more internal procedures and one or more exported procedures. For example, the following module defines one internal procedure (defined with <code>proc</code> instruction) and one exported procedure (defined with <code>export</code> instruction):</p>
<pre><code>proc.foo
    &lt;instructions&gt;
end

export.bar
    &lt;instructions&gt;
    exec.foo
    &lt;instructions&gt;
end
</code></pre>
<h4 id="programs"><a class="header" href="#programs">Programs</a></h4>
<p>Executable modules are used to define programs. A program contains zero or more internal procedures (defined with <code>proc</code> instruction) and exactly one main procedure (defined with <code>begin</code> instruction). For example, the following module defines one internal procedure and a main procedure:</p>
<pre><code>proc.foo
    &lt;instructions&gt;
end

begin
    &lt;instructions&gt;
    exec.foo
    &lt;instructions&gt;
end
</code></pre>
<p>A program cannot contain any exported procedures.</p>
<p>When a program is executed, the execution starts at the first instruction following the <code>begin</code> instruction. The main procedure is expected to be the last procedure in the program and can be followed only by comments.</p>
<h4 id="importing-modules"><a class="header" href="#importing-modules">Importing modules</a></h4>
<p>To invoke a procedure from an external module, the module first needs to be imported using a <code>use</code> instruction. Once a module is imported, procedures from this module can be invoked via the regular <code>exec</code> or <code>call</code> instructions as <code>exec|call.&lt;module&gt;::&lt;label&gt;</code> where <code>label</code> is the name of the procedure. For example:</p>
<pre><code>use.std::math::u64

begin
    push.1.0
    push.2.0
    exec.u64::checked_add
end
</code></pre>
<p>In the above example we import <code>std::math::u64</code> module from the <a href="../stdlib/main.html">standard library</a>. We then execute a program which pushes two 64-bit integers onto the stack, and then invokes a 64-bit addition procedure from the imported module.</p>
<p>The set of modules which can be imported by a program can be specified via a Module Provider when instantiating the <a href="https://crates.io/crates/miden-assembly">Miden Assembler</a> used to compile the program.</p>
<h3 id="constants"><a class="header" href="#constants">Constants</a></h3>
<p>Miden assembly supports constant declarations. These constants are scoped to the module they are defined in and can be used as immediate parameters for Miden assembly instructions. Currently only <code>push</code> instruction supports this.</p>
<p>Constants must be declared right after module imports and before any procedures or program bodies. A constant's name must start with an upper-case letter and can contain any combination of numbers, upper-case ASCII letters, and underscores (<code>_</code>). The number of characters in a constant name cannot exceed 100.</p>
<pre><code>use.std::math::u64

const.CONSTANT_1=100
const.CONSTANT_2=200

begin
    push.CONSTANT_1.CONSTANT_2
    exec.u64::checked_add
end

</code></pre>
<h3 id="comments"><a class="header" href="#comments">Comments</a></h3>
<p>Miden assembly allows annotating code with simple comments. There are two types of comments: single-line comments which start with a <code>#</code> (pound) character, and documentation comments which start with <code>#!</code> characters. For example:</p>
<pre><code>#! This is a documentation comment
export.foo
    # this is a comment
    push.1
end
</code></pre>
<p>Documentation comments must precede a procedure declaration. Using them inside a procedure body is an error.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../user_docs/assembly/main.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../user_docs/assembly/execution_contexts.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../user_docs/assembly/main.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../user_docs/assembly/execution_contexts.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
